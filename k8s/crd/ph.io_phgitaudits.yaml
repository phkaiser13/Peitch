# Copyright (C) 2025 Pedro Henrique / phkaiser13
#
# File: k8s/crd/ph.io_phgitaudits.yaml
#
# This file defines the Custom Resource Definition (CRD) for the PhgitAudit
# resource. This CRD provides the foundation for a centralized,
# Kubernetes-native audit logging system. Each instance of a PhgitAudit
# resource represents a single, immutable audit event generated by a phgit
# operation.
#
# Architecture:
# - It establishes the 'PhgitAudit' kind within the 'ph.io' API group.
# - The resource is Cluster-scoped to capture events that are not tied to a
#   single namespace, such as cluster-level RBAC changes.
# - The `spec` is designed to be a structured log entry, containing essential
#   information like a timestamp, the component that generated the event, the
#   action (verb) performed, and the actor who initiated it.
# - The `details` field is an unstructured map, providing the flexibility to
#   store context-specific information for different types of events without
#   requiring schema changes.
# - By storing audit logs as Kubernetes resources, they can be listed, watched,
#   and queried using standard tools like `kubectl`, and permissions to view
#   them can be managed via standard Kubernetes RBAC. This makes the Kubernetes
#   API the "centralized store" for audit information.
#
# SPDX-License-Identifier: Apache-2.0
#

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  # name must be in the form: <plural>.<group>
  name: phgitaudits.ph.io
spec:
  # group name to use for REST API: /apis/<group>/<version>
  group: ph.io
  # The scope can be either Namespaced or Cluster.
  scope: Cluster
  names:
    # plural name to be used in the URL: /apis/<group>/<version>/<plural>
    plural: phgitaudits
    # singular name to be used as an alias on the CLI and for display
    singular: phgitaudit
    # kind is normally the CamelCased singular type. Your resource manifests use this.
    kind: PhgitAudit
    # shortNames allow shorter string to match your resource on the CLI
    shortNames:
    - pha
  # list of versions supported by this CustomResourceDefinition
  versions:
    - name: v1alpha1
      # Each version can be enabled/disabled by the Served flag.
      served: true
      # One and only one version must be marked as the storage version.
      storage: true
      schema:
        # openAPIV3Schema is the schema for validating custom objects.
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - timestamp
                - verb
                - component
              properties:
                timestamp:
                  type: string
                  format: date-time
                  description: "The time at which the event occurred."
                verb:
                  type: string
                  description: "The action performed, e.g., 'grant', 'revoke', 'create', 'delete'."
                component:
                  type: string
                  description: "The phgit component that generated the event, e.g., 'rbac_manager', 'release_orchestrator'."
                actor:
                  type: object
                  description: "The user or system that performed the action. This may be empty if not available."
                  properties:
                    user:
                      type: string
                      description: "The username of the actor."
                    sourceIp:
                      type: string
                      description: "The IP address from which the action was initiated."
                target:
                  type: object
                  description: "The primary resource that was the target of the action."
                  properties:
                    kind:
                      type: string
                      description: "The kind of the target resource (e.g., 'RoleBinding', 'Cluster')."
                    name:
                      type: string
                      description: "The name of the target resource."
                    namespace:
                      type: string
                      description: "The namespace of the target resource, if applicable."
                details:
                  type: object
                  description: "A map of additional key-value pairs providing context about the event."
                  # This allows for arbitrary fields, making the audit log flexible.
                  x-kubernetes-preserve-unknown-fields: true
